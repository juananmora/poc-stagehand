# Stagehand POC - CI/CD Pipeline
# 
# This workflow runs Playwright tests with Stagehand AI automation
#
# ============================================
# DEPENDENCIES INSTALLED
# ============================================
# NPM packages (via npm ci):
#   - @browserbasehq/stagehand: AI-powered browser automation SDK
#   - @playwright/test: E2E testing framework
#   - openai: OpenAI-compatible LLM client
#   - dotenv: Environment variable management
#   - tsx: TypeScript execution
#   - typescript: TypeScript compiler
#
# System dependencies:
#   - Chromium browser (via playwright install)
#   - Ollama (optional, for local LLM)
#
# ============================================
# LLM OPTIONS
# ============================================
# Option 1: OpenAI API (default, requires OPENAI_API_KEY secret)
# Option 2: Ollama local (select via workflow_dispatch, no API key needed)
#
# ============================================
# REQUIRED SECRETS (for OpenAI mode)
# ============================================
#   - OPENAI_API_KEY: OpenAI API key
#
# ============================================
# SETUP INSTRUCTIONS
# ============================================
# For OpenAI:
#   1. Go to GitHub repo > Settings > Secrets and variables > Actions
#   2. Add secret: OPENAI_API_KEY with your OpenAI API key
#
# For Ollama:
#   1. Run workflow manually with llm_provider = "ollama"
#   2. No secrets needed (runs locally in CI)

name: Playwright Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      llm_provider:
        type: choice
        description: 'LLM Provider'
        required: true
        default: 'openai'
        options:
          - openai
          - ollama
      ollama_model:
        type: string
        description: 'Ollama model (only if llm_provider=ollama)'
        required: false
        default: 'qwen2.5:0.5b'
      debug_enabled:
        type: boolean
        description: 'Run with debug logging'
        required: false
        default: false

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # Default to OpenAI for push/PR, can be overridden via workflow_dispatch
  LLM_PROVIDER: ${{ inputs.llm_provider || 'openai' }}
  OLLAMA_MODEL: ${{ inputs.ollama_model || 'qwen2.5:0.5b' }}

jobs:
  test:
    name: Run Playwright Tests (${{ inputs.llm_provider || 'openai' }})
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ============================================
      # CHECKOUT & SETUP
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ============================================
      # OLLAMA INSTALLATION (conditional)
      # ============================================
      - name: Install Ollama
        if: env.LLM_PROVIDER == 'ollama'
        run: |
          echo "============================================"
          echo "INSTALLING OLLAMA"
          echo "============================================"
          curl -fsSL https://ollama.com/install.sh | sh
          echo "Ollama installed successfully"
          ollama --version

      - name: Start Ollama server
        if: env.LLM_PROVIDER == 'ollama'
        run: |
          echo "Starting Ollama server in background..."
          ollama serve &
          
          # Wait for server to be ready
          echo "Waiting for Ollama server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "âœ… Ollama server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify server is running
          if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
            echo "âŒ Ollama server failed to start"
            exit 1
          fi

      - name: Pull Ollama model
        if: env.LLM_PROVIDER == 'ollama'
        run: |
          echo "============================================"
          echo "PULLING OLLAMA MODEL: ${{ env.OLLAMA_MODEL }}"
          echo "============================================"
          echo "This may take a few minutes..."
          ollama pull ${{ env.OLLAMA_MODEL }}
          echo ""
          echo "Available models:"
          ollama list

      - name: Verify Ollama is working
        if: env.LLM_PROVIDER == 'ollama'
        run: |
          echo "Testing Ollama with a simple prompt..."
          curl -s http://localhost:11434/api/generate -d '{
            "model": "${{ env.OLLAMA_MODEL }}",
            "prompt": "Say hello",
            "stream": false
          }' | jq -r '.response' | head -c 200
          echo ""
          echo "âœ… Ollama is working!"

      # ============================================
      # NPM DEPENDENCY INSTALLATION
      # ============================================
      # Note: Using 'npm install' instead of 'npm ci' because:
      # 1. package-lock.json may have Windows-specific paths
      # 2. Allows resolution of peer dependency conflicts
      # 3. Regenerates lock file for Linux environment
      - name: Install npm dependencies
        run: |
          # Remove potentially Windows-generated lock file
          rm -f package-lock.json
          # Install with legacy peer deps to handle zod conflicts
          npm install --legacy-peer-deps
          echo "âœ… Dependencies installed successfully"

      - name: Verify Stagehand installation
        run: |
          echo "Checking installed packages..."
          npm ls @browserbasehq/stagehand
          npm ls @playwright/test
          npm ls openai
          echo "âœ… All critical dependencies installed"

      # ============================================
      # PLAYWRIGHT BROWSER INSTALLATION
      # ============================================
      - name: Get Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(npm ls @playwright/test --json | jq -r '.dependencies["@playwright/test"].version // .devDependencies["@playwright/test"].version')
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      # ============================================
      # ENVIRONMENT CONFIGURATION
      # ============================================
      - name: Create .env file (OpenAI)
        if: env.LLM_PROVIDER == 'openai'
        run: |
          cat > .env << EOF
          # OpenAI Configuration
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OLLAMA_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OLLAMA_API_BASE=https://api.openai.com/v1
          EOF

      - name: Create .env file (Ollama)
        if: env.LLM_PROVIDER == 'ollama'
        run: |
          cat > .env << EOF
          # Ollama Local Configuration
          OLLAMA_API_KEY=ollama
          OLLAMA_API_BASE=http://localhost:11434/v1
          OLLAMA_MODEL=${{ env.OLLAMA_MODEL }}
          EOF

      - name: Verify environment and dependencies
        run: |
          echo "============================================"
          echo "ENVIRONMENT"
          echo "============================================"
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
          echo "Working directory: $(pwd)"
          echo ""
          echo "============================================"
          echo "LLM CONFIGURATION"
          echo "============================================"
          echo "LLM Provider: ${{ env.LLM_PROVIDER }}"
          if [ "${{ env.LLM_PROVIDER }}" == "ollama" ]; then
            echo "Ollama Model: ${{ env.OLLAMA_MODEL }}"
            echo "Ollama Endpoint: http://localhost:11434"
            echo "Ollama Status: $(curl -s http://localhost:11434/api/tags | jq -r '.models | length') models available"
          else
            echo "OpenAI Endpoint: https://api.openai.com/v1"
            echo "API Key configured: ${{ secrets.OPENAI_API_KEY != '' && 'Yes' || 'No' }}"
          fi
          echo ""
          echo "============================================"
          echo "INSTALLED PACKAGES"
          echo "============================================"
          echo "Playwright: $(npx playwright --version)"
          npm ls @browserbasehq/stagehand --depth=0 2>/dev/null || echo "Stagehand: installed"
          npm ls openai --depth=0 2>/dev/null || echo "OpenAI SDK: installed"

      # ============================================
      # BUILD
      # ============================================
      - name: Build TypeScript
        run: npm run build
        continue-on-error: true

      # ============================================
      # RUN TESTS
      # ============================================
      - name: Run Playwright tests
        run: npx playwright test
        env:
          CI: true
          DEBUG: ${{ inputs.debug_enabled && 'pw:api' || '' }}
          # OpenAI configuration
          OPENAI_API_KEY: ${{ env.LLM_PROVIDER == 'openai' && secrets.OPENAI_API_KEY || 'ollama' }}
          # Ollama configuration (used by the app)
          OLLAMA_API_KEY: ${{ env.LLM_PROVIDER == 'ollama' && 'ollama' || secrets.OPENAI_API_KEY }}
          OLLAMA_API_BASE: ${{ env.LLM_PROVIDER == 'ollama' && 'http://localhost:11434/v1' || 'https://api.openai.com/v1' }}

      # ============================================
      # UPLOAD ARTIFACTS
      # ============================================
      - name: Upload Playwright HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ env.LLM_PROVIDER }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ env.LLM_PROVIDER }}
          path: test-results/
          retention-days: 30

      - name: Upload execution reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: execution-reports-${{ env.LLM_PROVIDER }}
          path: reports/
          retention-days: 30
          if-no-files-found: ignore

      # ============================================
      # CLEANUP (Ollama)
      # ============================================
      - name: Stop Ollama server
        if: always() && env.LLM_PROVIDER == 'ollama'
        run: |
          echo "Stopping Ollama server..."
          pkill ollama || true
          echo "Ollama server stopped"

      # ============================================
      # SUMMARY
      # ============================================
      - name: Add test summary to GitHub
        if: always()
        run: |
          echo "## Test Results (${{ env.LLM_PROVIDER }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**LLM Provider:** ${{ env.LLM_PROVIDER }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.LLM_PROVIDER }}" == "ollama" ]; then
            echo "**Ollama Model:** ${{ env.OLLAMA_MODEL }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/results.json ]; then
            PASSED=$(jq '.stats.expected // 0' test-results/results.json)
            FAILED=$(jq '.stats.unexpected // 0' test-results/results.json)
            SKIPPED=$(jq '.stats.skipped // 0' test-results/results.json)
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View full report](../artifacts/playwright-report-${{ env.LLM_PROVIDER }})" >> $GITHUB_STEP_SUMMARY
